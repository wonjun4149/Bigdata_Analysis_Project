<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì›¹íˆ°ìš”ì•½ì†Œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../CSS/summary_main.css">
  <link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
</head>
<body>
  <header>
      <nav class="logo-group">
          <a href="/index.html" class="logo-image"> <img src="/logo.png" alt="ì›¹íˆ°ì„¸ìƒ ë¡œê³ ">
          </a>
          <a href="/html/recommand_main.php" class="text-logo">ì›¹íˆ°ì¶”ì²œì†Œ</a> </nav>
  </header>

  <main>
    <h1>ì›¹íˆ°ìš”ì•½ì†Œ</h1>
    <div class="search-container">
      <form id="search-form">
        <input
          type="text"
          id="search-query"
          class="search-input"
          placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          autocomplete="off"
        />
        <button type="submit" class="search-btn">ğŸ”</button>
      </form>
    </div>
  </main>

  <!-- ê²€ìƒ‰ ê²°ê³¼ íŒì—… -->
  <div class="popup" id="search-popup">
    <div class="popup-content">
      <div class="popup-header">ê²€ìƒ‰ ê²°ê³¼</div>
      <div class="content-body">
        <p><strong>ì›¹íˆ° ì œëª©:</strong> <span id="webtoon-title"></span></p>
        <p><strong>ì—°ì¬ ìš”ì¼:</strong> <span id="webtoon-day"></span></p>
        <p><strong>ë§ˆì§€ë§‰ í™”:</strong> <span id="webtoon-last"></span></p>
        <div class="episode-input-group">
          <label for="start-episode">ì‹œì‘ í™”:</label>
          <input type="number" id="start-episode" placeholder="1" />
        </div>
        <div class="episode-input-group">
          <label for="end-episode">ë§ˆì§€ë§‰ í™”:</label>
          <input type="number" id="end-episode" placeholder="3" />
        </div>
      </div>
      <div class="popup-footer">
        <p class="disclaimer-text">ì›¹íˆ°ì„¸ìƒ AIëŠ” ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ì¤‘ìš”í•œ ë‚´ìš©ì€ ì§ì ‘ ê°ìƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>
        <button id="submit-request">ìš”ì•½ ìš”ì²­</button>
        <button type="button" onclick="closePopup()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì§„í–‰ ìƒí™© íŒì—… -->
  <div class="popup" id="progress-popup">
    <div class="popup-content">
      <div class="popup-header">ìš”ì•½ ì§„í–‰</div>
      <div class="content-body">
        <p id="progress-text">ìš”ì•½ì¤‘...</p>
        <div class="progress-bar-container">
            <div class="progress-bar"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ê²°ê³¼ íŒì—… -->
  <div class="popup" id="result-popup">
    <div class="popup-content">
      <div class="popup-header">ìš”ì•½ ê²°ê³¼</div>
      <div class="content-body">
        <p id="page-info"></p>
        <div id="summary-text"></div>
      </div>
      <div class="popup-footer">
        <button id="prev-page">ì´ì „</button>
        <button id="next-page">ë‹¤ìŒ</button>
        <button type="button" onclick="closePopup()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    let currentWebtoonId = null;
    let maxEpisode = 0;
    let pages = [];
    let pageRanges = [];
    let currentPage = 0;
    let chunkStartTimes = []; // To store start times of each summary task

    function openPopup(id) {
      document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
      const popup = document.getElementById(id);
      popup.style.display = 'block';
      document.body.style.overflow = 'hidden';
      if (id === 'search-popup') {
        const startEpisodeInput = document.getElementById('start-episode');
        if (startEpisodeInput) {
          startEpisodeInput.focus();
        }
      }
    }
    
    function closePopup() {
      document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
      document.body.style.overflow = 'auto';
    }

    document.getElementById('search-form').addEventListener('submit', e => {
      e.preventDefault();
      const q = document.getElementById('search-query').value.trim();
      if (!q) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

      fetch(`/php/search_webtoon.php?title=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => {
          if (data.error) return alert(data.error);
          document.getElementById('webtoon-title').textContent = data.title;
          document.getElementById('webtoon-day').textContent = data.day;
          document.getElementById('webtoon-last').textContent = data.last;
          currentWebtoonId = data.S_N;
          maxEpisode = parseInt(data.last, 10);
          openPopup('search-popup');
        })
        .catch(err => {
          console.error(err);
          alert('ê²€ìƒ‰ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    });

    document.getElementById('submit-request').addEventListener('click', async () => {
      const startEp = parseInt(document.getElementById('start-episode').value, 10);
      const endEp = parseInt(document.getElementById('end-episode').value, 10);
      if (isNaN(startEp) || isNaN(endEp)) return alert('ì‹œì‘ í™”ì™€ ë§ˆì§€ë§‰ í™”ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      if (startEp < 1 || endEp > maxEpisode || startEp > endEp) return alert(`1 â‰¤ ì‹œì‘ í™” â‰¤ ë§ˆì§€ë§‰ í™” â‰¤ ${maxEpisode} ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);

      openPopup('progress-popup');
      const progressTextElement = document.getElementById('progress-text');
      const progressBar = document.querySelector('#progress-popup .progress-bar');

      progressBar.style.width = '0%';
      progressBar.style.transition = 'none';
      progressBar.getBoundingClientRect();
      progressBar.style.transition = 'width 35s linear';
      progressBar.style.width = '100%';

      // Reset states
      pages = [];
      pageRanges = [];
      chunkStartTimes = [];
      currentPage = 0;
      document.getElementById('next-page').classList.remove('loading-spinner');
      document.getElementById('next-page').style.setProperty('--delay', '0s');


      for (let i = startEp; i <= endEp; i += 15) {
        const chunkStart = i;
        const chunkEnd = Math.min(i + 14, endEp);
        pageRanges.push({ start: chunkStart, end: chunkEnd });
      }

      if (pageRanges.length === 0) {
        alert('ìš”ì²­í•  í™” ë²”ìœ„ê°€ ì—†ìŠµë‹ˆë‹¤.');
        closePopup();
        return;
      }

      try {
        const firstRange = pageRanges[0];
        progressTextElement.textContent = `ìš”ì•½ ì§„í–‰ ì¤‘... (${firstRange.start}í™” ~ ${firstRange.end}í™”) [1/${pageRanges.length}]`;
        
        const response = await fetch(`/php/get_summary.php?S_N=${currentWebtoonId}&start=${firstRange.start}&end=${firstRange.end}`);
        if (!response.ok) throw new Error(`[${firstRange.start}í™”~${firstRange.end}í™”] ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
        
        const data = await response.json();
        if (data.result) {
          pages.push(data.result);
          currentPage = 0;
          updateSummaryDisplay();
          openPopup('result-popup');

          if (pageRanges.length > 1) {
            chunkStartTimes[1] = Date.now(); // Record start time for the *next* chunk
            summarizeRemainingChunks();
          }
        } else {
          throw new Error(data.error || `[${firstRange.start}í™”~${firstRange.end}í™”] ìš”ì•½ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
        }
      } catch (err) {
        console.error('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err);
        alert('ìš”ì•½ ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        closePopup();
      } finally {
        progressTextElement.textContent = 'ìš”ì•½ì¤‘...';
      }
    });

    async function summarizeRemainingChunks() {
      const nextBtn = document.getElementById('next-page');
      
      try {
        for (let i = 1; i < pageRanges.length; i++) {
          const range = pageRanges[i];
          document.getElementById('progress-text').textContent = `ìš”ì•½ ì§„í–‰ ì¤‘... (${range.start}í™” ~ ${range.end}í™”) [${i + 1}/${pageRanges.length}]`;

          let fetchUrl = `/php/get_summary.php?S_N=${currentWebtoonId}&start=${range.start}&end=${range.end}`;
          if (pages[i - 1]) {
            fetchUrl += `&prev_summary=${encodeURIComponent(pages[i - 1])}`;
          }

          const response = await fetch(fetchUrl);
          if (!response.ok) throw new Error(`[${range.start}í™”~${range.end}í™”] ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);

          const data = await response.json();
          if (data.result) {
            pages.push(data.result);
            if (pageRanges[i + 1]) {
                chunkStartTimes[i + 1] = Date.now(); // Record start time for the next chunk
            }
            updateSummaryDisplay();
          } else {
            throw new Error(data.error || `[${range.start}í™”~${range.end}í™”] ìš”ì•½ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
          }
        }
      } catch (err) {
        console.error('ì¶”ê°€ ìš”ì•½ ì¤‘ ì˜¤ë¥˜:', err);
        alert('ì¶”ê°€ ìš”ì•½ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
      } finally {
        updateSummaryDisplay();
      }
    }

    function updateSummaryDisplay() {
      const infoEl = document.getElementById('page-info');
      const textEl = document.getElementById('summary-text');
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      
      if (pages.length === 0 || !pageRanges[currentPage]) {
        infoEl.textContent = 'í‘œì‹œí•  ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤.';
        textEl.textContent = '';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }

      const range = pageRanges[currentPage];
      infoEl.textContent = `ìš”ì•½ ${currentPage + 1}/${pageRanges.length}: ${range.start}í™”~${range.end}í™”`;
      textEl.textContent = pages[currentPage];
      prevBtn.disabled = currentPage === 0;
      nextBtn.disabled = currentPage >= pages.length - 1;

      if (nextBtn.disabled && currentPage < pageRanges.length - 1) {
          nextBtn.textContent = 'ìš”ì•½ì¤‘...';
          nextBtn.classList.add('loading-spinner');
          
          const startTime = chunkStartTimes[currentPage + 1];
          if (startTime) {
              const elapsedTime = (Date.now() - startTime) / 1000; // in seconds
              nextBtn.style.setProperty('--delay', `-${elapsedTime}s`);
          } else {
              nextBtn.style.setProperty('--delay', '0s');
          }

      } else {
          nextBtn.textContent = 'ë‹¤ìŒ';
          nextBtn.classList.remove('loading-spinner');
          nextBtn.style.setProperty('--delay', '0s');
      }
    }

    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        updateSummaryDisplay();
      }
    });

    document.getElementById('next-page').addEventListener('click', () => {
      if (currentPage < pages.length - 1) {
        currentPage++;
        updateSummaryDisplay();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePopup();
    });

    document.addEventListener('DOMContentLoaded', function() {
      const elements = document.querySelectorAll('main > *');
      elements.forEach((el, index) => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        setTimeout(() => {
          el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
          el.style.opacity = '1';
          el.style.transform = 'translateY(0)';
        }, index * 100);
      });
      document.getElementById('search-query').focus();
    });

    document.getElementById('end-episode').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault(); 
        document.getElementById('submit-request').click();
      }
    });
  </script>
</body>
</html>