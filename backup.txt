<!DOCTYPE html>

<html lang="ko">

<head>

Â  <meta charset="UTF-8" />

Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

Â  <title>ì›ì¤€ì´ì˜ ì›¹íˆ°ìš”ì•½ì†Œ</title>

Â  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

Â  <link rel="stylesheet" href="../CSS/summary_main.css">

</head>

<body>

Â  <!-- í—¤ë”: ì™¼ìª½ ìƒë‹¨ ë¡œê³  -->

Â  <header>

Â  Â  <nav class="logo-group">

Â  Â  Â  <a href="/index.html" class="logo">ì›¹íˆ°ì„¸ìƒ</a>

Â  Â  Â  <a href="/html/recommand_main.php" class="logo">ì›¹íˆ°ì¶”ì²œì†Œ</a>

Â  Â  </nav>

Â  </header>



Â  <!-- ë©”ì¸: íƒ€ì´í‹€ + ê²€ìƒ‰ì°½ì„ í™”ë©´ ì¤‘ì•™ì— -->

Â  <main>

Â  Â  <h1>ì›¹íˆ°ìš”ì•½ì†Œ</h1>

Â  Â  <div class="search-container">

Â  Â  Â  <form id="search-form">

Â  Â  Â  Â  <input

Â  Â  Â  Â  Â  type="text"

Â  Â  Â  Â  Â  id="search-query"

Â  Â  Â  Â  Â  class="search-input"

Â  Â  Â  Â  Â  placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"

Â  Â  Â  Â  Â  autocomplete="off"

Â  Â  Â  Â  />

Â  Â  Â  Â  <button type="submit" class="search-btn">ğŸ”</button>

Â  Â  Â  </form>

Â  Â  </div>

Â  </main>



Â  <!-- ê²€ìƒ‰ ê²°ê³¼ íŒì—… -->

Â  <div class="popup" id="search-popup">

Â  Â  <div class="popup-header">ê²€ìƒ‰ ê²°ê³¼</div>

Â  Â  <div class="popup-content">

Â  Â  Â  <p><strong>ì›¹íˆ° ì œëª©:</strong> <span id="webtoon-title"></span></p>

Â  Â  Â  <p><strong>ì—°ì¬ ìš”ì¼:</strong> <span id="webtoon-day"></span></p>

Â  Â  Â  <p><strong>ë§ˆì§€ë§‰ í™”:</strong> <span id="webtoon-last"></span></p>

Â  Â  Â  <div class="episode-input-group">

Â  Â  Â  Â  <label for="start-episode">ì‹œì‘ í™”:</label>

Â  Â  Â  Â  <input type="number" id="start-episode" placeholder="1" />

Â  Â  Â  </div>

Â  Â  Â  <div class="episode-input-group">

Â  Â  Â  Â  <label for="end-episode">ë§ˆì§€ë§‰ í™”:</label>

Â  Â  Â  Â  <input type="number" id="end-episode" placeholder="3" />

Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <div class="popup-footer">

Â  Â  Â  <button id="submit-request">ìš”ì•½ ìš”ì²­</button>

Â  Â  Â  <button type="button" onclick="closePopup()">ë‹«ê¸°</button>

Â  Â  </div>

Â  </div>



Â  <!-- ì§„í–‰ íŒì—… -->

Â  <div class="popup" id="progress-popup">

Â  Â  <div class="popup-header">ìš”ì•½ ì§„í–‰</div>

Â  Â  <div class="popup-content">

Â  Â  Â  <p id="progress-text">ìš”ì•½ì¤‘...</p>

Â  Â  </div>

Â  </div>



Â  <!-- ìš”ì•½ ê²°ê³¼ íŒì—… -->

Â  <div class="popup" id="result-popup">

Â  Â  <div class="popup-header">ìš”ì•½ ê²°ê³¼</div>

Â  Â  <div class="popup-content">

Â  Â  Â  <p id="page-info"></p>

Â  Â  Â  <p id="summary-text"></p>

Â  Â  </div>

Â  Â  <div class="popup-footer">

Â  Â  Â  <button id="prev-page">ì´ì „</button>

Â  Â  Â  <button id="next-page">ë‹¤ìŒ</button>

Â  Â  Â  <button type="button" onclick="closePopup()">ë‹«ê¸°</button>

Â  Â  </div>

Â  </div>



Â  <script>

Â  Â  let currentWebtoonId = null;

Â  Â  let maxEpisode = 0;

Â  Â  let pages = [];

Â  Â  let pageRanges = [];

Â  Â  let currentPage = 0;



Â  Â  function openPopup(id) {

Â  Â  Â  document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');

Â  Â  Â  document.getElementById(id).style.display = 'block';

Â  Â  }

Â  Â  function closePopup() {

Â  Â  Â  document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');

Â  Â  }



Â  Â  document.getElementById('search-form').addEventListener('submit', e => {

Â  Â  Â  e.preventDefault();

Â  Â  Â  const q = document.getElementById('search-query').value.trim();

Â  Â  Â  if (!q) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');



Â  Â  Â  fetch(`/php/search_webtoon.php?title=${encodeURIComponent(q)}`)

Â  Â  Â  Â  .then(r => r.json())

Â  Â  Â  Â  .then(data => {

Â  Â  Â  Â  Â  if (data.error) return alert(data.error);

Â  Â  Â  Â  Â  document.getElementById('webtoon-title').textContent = data.title;

Â  Â  Â  Â  Â  document.getElementById('webtoon-day').textContent = data.day;

Â  Â  Â  Â  Â  document.getElementById('webtoon-last').textContent = data.last;

Â  Â  Â  Â  Â  currentWebtoonId = data.S_N;

Â  Â  Â  Â  Â  maxEpisode = parseInt(data.last, 10);

Â  Â  Â  Â  Â  openPopup('search-popup');

Â  Â  Â  Â  })

Â  Â  Â  Â  .catch(err => {

Â  Â  Â  Â  Â  console.error(err);

Â  Â  Â  Â  Â  alert('ê²€ìƒ‰ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');

Â  Â  Â  Â  });

Â  Â  });



Â  Â  document.getElementById('submit-request').addEventListener('click', () => {

Â  Â  Â  const startEp = parseInt(document.getElementById('start-episode').value, 10);

Â  Â  Â  const endEp = parseInt(document.getElementById('end-episode').value, 10);

Â  Â  Â  if (isNaN(startEp) || isNaN(endEp))

Â  Â  Â  Â  return alert('ì‹œì‘ í™”ì™€ ë§ˆì§€ë§‰ í™”ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

Â  Â  Â  if (startEp < 1 || endEp > maxEpisode || startEp > endEp)

Â  Â  Â  Â  return alert(`1 â‰¤ ì‹œì‘ í™” â‰¤ ë§ˆì§€ë§‰ í™” â‰¤ ${maxEpisode} ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);



Â  Â  Â  // í˜ì´ì§€ ë¶„í• : 15í™”ì”©

Â  Â  Â  pages = [];

Â  Â  Â  pageRanges = [];

Â  Â  Â  currentPage = 0;

Â  Â  Â  for (let i = startEp; i <= endEp; i += 15) {

Â  Â  Â  Â  const chunkStart = i;

Â  Â  Â  Â  const chunkEnd = Math.min(i + 14, endEp);

Â  Â  Â  Â  pageRanges.push({ start: chunkStart, end: chunkEnd });

Â  Â  Â  }



Â  Â  Â  const fetchPromises = pageRanges.map(range =>

Â  Â  Â  Â  fetch(`/php/get_summary.php?S_N=${currentWebtoonId}&start=${range.start}&end=${range.end}`)

Â  Â  Â  Â  Â  .then(r => r.json())

Â  Â  Â  Â  Â  .then(data => {

Â  Â  Â  Â  Â  Â  if (data.result) return data.result;

Â  Â  Â  Â  Â  Â  throw new Error(data.error);

Â  Â  Â  Â  Â  })

Â  Â  Â  );



Â  Â  Â  openPopup('progress-popup');

Â  Â  Â  Promise.all(fetchPromises)

Â  Â  Â  Â  .then(results => {

Â  Â  Â  Â  Â  pages = results;

Â  Â  Â  Â  Â  updateSummaryDisplay();

Â  Â  Â  Â  Â  openPopup('result-popup');

Â  Â  Â  Â  })

Â  Â  Â  Â  .catch(err => {

Â  Â  Â  Â  Â  console.error(err);

Â  Â  Â  Â  Â  alert('ìš”ì•½ ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);

Â  Â  Â  Â  Â  closePopup();

Â  Â  Â  Â  });

Â  Â  });



Â  Â  function updateSummaryDisplay() {

Â  Â  Â  const infoEl = document.getElementById('page-info');

Â  Â  Â  const textEl = document.getElementById('summary-text');

Â  Â  Â  const prevBtn = document.getElementById('prev-page');

Â  Â  Â  const nextBtn = document.getElementById('next-page');

Â  Â  Â  const range = pageRanges[currentPage];

Â  Â  Â  infoEl.textContent = `Phase ${currentPage + 1}: ${range.start}í™”~${range.end}í™”`;

Â  Â  Â  textEl.textContent = pages[currentPage];

Â  Â  Â  prevBtn.disabled = currentPage === 0;

Â  Â  Â  nextBtn.disabled = currentPage === pages.length - 1;

Â  Â  }



Â  Â  document.getElementById('prev-page').addEventListener('click', () => {

Â  Â  Â  if (currentPage > 0) {

Â  Â  Â  Â  currentPage--;

Â  Â  Â  Â  updateSummaryDisplay();

Â  Â  Â  }

Â  Â  });

Â  Â  document.getElementById('next-page').addEventListener('click', () => {

Â  Â  Â  if (currentPage < pages.length - 1) {

Â  Â  Â  Â  currentPage++;

Â  Â  Â  Â  updateSummaryDisplay();

Â  Â  Â  }

Â  Â  });

Â  </script>

</body>

</html>

========================================================================
2025/08/12


<?php
ini_set('display_errors', 1);          // í™”ë©´ì— ì˜¤ë¥˜ë¥¼ í‘œì‹œí•˜ë„ë¡ ì„¤ì •
ini_set('display_startup_errors', 1); // ì‹œì‘ ì˜¤ë¥˜ë„ í‘œì‹œí•˜ë„ë¡ ì„¤ì •
error_reporting(E_ALL);               // ëª¨ë“  ì¢…ë¥˜ì˜ ì˜¤ë¥˜ë¥¼ ë³´ê³ í•˜ë„ë¡ ì„¤ì •

// AJAX ìš”ì²­ì€ POST ë°©ì‹ìœ¼ë¡œ ë“¤ì–´ì˜¨ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $userInput = $_POST['text'] ?? '';

    // ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬
    if (empty($userInput)) {
        echo json_encode(['error' => 'ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.']);
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }

    // Python ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ ë° ì‹¤í–‰ íŒŒì¼ ì„¤ì •
    $pythonScriptPath = "/var/www/html/Python/recommand.py"; // ì‹¤ì œ ê²½ë¡œë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.
    $pythonExecutable = "python3"; // ë˜ëŠ” "python"

    // Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ëª…ë ¹ì–´ ì¤€ë¹„
    // escapeshellcmdëŠ” ëª…ë ¹ì–´ ìì²´ì˜ ìœ„í—˜í•œ ë¬¸ì ë°©ì§€, addslashesëŠ” Pythonìœ¼ë¡œ ì „ë‹¬ë  ë¬¸ìì—´ ë‚´ ë”°ì˜´í‘œ ì²˜ë¦¬
    $command = $pythonExecutable . " " . escapeshellcmd($pythonScriptPath) . " '" . addslashes($userInput) . "'";
    
    // Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (í‘œì¤€ ì˜¤ë¥˜ë„ í•¨ê»˜ ìº¡ì²˜)
    $output = shell_exec($command . " 2>&1");

    // Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê²°ê³¼ í™•ì¸
    if ($output === null) {
        echo json_encode(['error' => 'Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤ (null). ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.']);
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }

    // Python ì¶œë ¥ ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ ë””ì½”ë”©
    $decodedOutput = json_decode($output, true);

    // JSON ë””ì½”ë”© ì˜¤ë¥˜ í™•ì¸
    if ($decodedOutput === null && json_last_error() !== JSON_ERROR_NONE) {
        echo json_encode([
            'error' => 'Python ì‘ë‹µ JSON íŒŒì‹± ì˜¤ë¥˜',
            'json_error_message' => json_last_error_msg(),
              //'raw_output_for_debug' => htmlspecialchars($output) // ë””ë²„ê¹… ì‹œì—ë§Œ ì´ ì¤„ì˜ ì£¼ì„ì„ í•´ì œí•˜ì—¬ í™•ì¸
        ]);
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }

    // Python ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì—ì„œ ë°œìƒí•œ ì˜¤ë¥˜ í™•ì¸
    if (isset($decodedOutput['error'])) {
        echo json_encode(['error' => 'Python ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ ì˜¤ë¥˜: ' . htmlspecialchars($decodedOutput['error'])]);
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }

    // 'recommended' í‚¤ ë˜ëŠ” ë°°ì—´ í˜•ì‹ í™•ì¸
    if (!isset($decodedOutput['recommended']) || !is_array($decodedOutput['recommended'])) {
        echo json_encode([
            'error' => 'Python ì‘ë‹µì— "recommended" ë°°ì—´ì´ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
            // 'decoded_output_for_debug' => $decodedOutput // ë””ë²„ê¹… ì‹œì—ë§Œ ì´ ì¤„ì˜ ì£¼ì„ì„ í•´ì œí•˜ì—¬ í™•ì¸
        ]);
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }

    $snListFromPython = $decodedOutput['recommended'];

    // Pythonìœ¼ë¡œë¶€í„° ë°›ì€ S_N ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜, ì¶”ì²œ ê²°ê³¼ê°€ ì—†ë‹¤ëŠ” ë©”ì‹œì§€ë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸
    if (empty($snListFromPython) || (count($snListFromPython) === 1 && strpos($snListFromPython[0], 'ì¶”ì²œí•  ì›¹íˆ°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤') !== false)) {
        echo json_encode(['error' => 'ì¶”ì²œí•  ì›¹íˆ°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (Pythonì´ ê²°ê³¼ë¥¼ ì°¾ì§€ ëª»í•¨)']);
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }
    
    // ìœ íš¨í•œ S_N (ìˆ«ìë¡œë§Œ êµ¬ì„±ëœ ë¬¸ìì—´)ë§Œ í•„í„°ë§
    $validSnList = [];
    foreach ($snListFromPython as $sn_item) {
        if (is_string($sn_item) && ctype_digit($sn_item)) {
            $validSnList[] = $sn_item;
        }
    }

    if (empty($validSnList)) {
        echo json_encode(['error' => 'Pythonìœ¼ë¡œë¶€í„° ìœ íš¨í•œ ì›¹íˆ° ì¶”ì²œ S_N ê°’ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.']);
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }
    
    // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì • (ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
    $db_host = "localhost";
    $db_user = "root";
    $db_pass = "123"; // ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½
    $db_name = "webtoon";

    $connection = new mysqli($db_host, $db_user, $db_pass, $db_name);

    // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜ í™•ì¸
    if ($connection->connect_error) {
        echo json_encode(['error' => 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: ' . $connection->connect_error]);
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }
    $connection->set_charset("utf8mb4"); // ë¬¸ì ì¸ì½”ë”© ì„¤ì •

    // SQL ì¿¼ë¦¬ ì¤€ë¹„ (IN ì ˆ ì‚¬ìš©)
    $placeholders = implode(',', array_fill(0, count($validSnList), '?'));
    // webtoon_info í…Œì´ë¸”ì— day, last ì»¬ëŸ¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í•„ìš”
    $query = "SELECT title, tag, summary, S_N, day, last FROM webtoon_info WHERE S_N IN ($placeholders)";

    $stmt = $connection->prepare($query);

    // SQL ì¿¼ë¦¬ ì¤€ë¹„ ì˜¤ë¥˜ í™•ì¸
    if ($stmt === false) {
        echo json_encode(['error' => 'SQL ì¿¼ë¦¬ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' . $connection->error]);
        $connection->close();
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }

    // íŒŒë¼ë¯¸í„° ë°”ì¸ë”© (S_N ê°’ë“¤ì€ ë¬¸ìì—´ë¡œ ê°€ì •)
    $types = str_repeat('s', count($validSnList));
    $stmt->bind_param($types, ...$validSnList);

    // SQL ì¿¼ë¦¬ ì‹¤í–‰
    if (!$stmt->execute()) {
        echo json_encode(['error' => 'SQL ì‹¤í–‰ ì˜¤ë¥˜: ' . $stmt->error]);
        $stmt->close();
        $connection->close();
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }

    $result = $stmt->get_result();

    // ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ ê²°ê³¼ í™•ì¸
    if ($result->num_rows === 0) {
        echo json_encode(['error' => 'í•´ë‹¹í•˜ëŠ” ì›¹íˆ° ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (S_N ì¡°íšŒ ê²°ê³¼ ì—†ìŒ)']);
        $stmt->close();
        $connection->close();
        exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
    }

    // ê²°ê³¼ ì²˜ë¦¬
    $webtoonInfo = [];
    while ($row = $result->fetch_assoc()) {
        // day, last ì»¬ëŸ¼ì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ null ë³‘í•© ì—°ì‚°ì ì‚¬ìš©
        $webtoonInfo[] = [
            'title'   => $row['title'] ?? 'ì œëª© ì—†ìŒ',
            'day'     => $row['day'] ?? 'ìš”ì¼ ì •ë³´ ì—†ìŒ', // webtoon_info í…Œì´ë¸”ì— 'day' ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸
            'last'    => $row['last'] ?? 'ìµœì‹ í™” ì •ë³´ ì—†ìŒ', // webtoon_info í…Œì´ë¸”ì— 'last' ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸
            'tag'     => $row['tag'] ?? 'íƒœê·¸ ì—†ìŒ',
            'summary' => $row['summary'] ?? 'ìš”ì•½ ì—†ìŒ',
            'S_N'     => $row['S_N'] ?? 'S_N ì—†ìŒ'
        ];
    }

    // ìµœì¢… ì„±ê³µ ì‘ë‹µ
    echo json_encode(['recommended' => $webtoonInfo]);

    // ë¦¬ì†ŒìŠ¤ ì •ë¦¬
    $stmt->close();
    $connection->close();
    exit; // ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ (í•„ìˆ˜!)

} else {
    // POST ìš”ì²­ì´ ì•„ë‹ ê²½ìš° (ì˜ˆ: ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ URLì„ ì…ë ¥í•˜ì—¬ ì ‘ì†)
    // ì´ ê²½ìš°ì—ëŠ” ì•„ë˜ HTML ë¶€ë¶„ì´ ê·¸ëŒ€ë¡œ í‘œì‹œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    // í•˜ì§€ë§Œ JavaScriptì˜ fetch ìš”ì²­ì€ POSTì´ë¯€ë¡œ, ìœ„ ë¡œì§ì—ì„œ ì²˜ë¦¬ë˜ê³  exit ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
    // ë§Œì•½ ì´ PHP íŒŒì¼ì´ ì˜¤ì§ API ì—”ë“œí¬ì¸íŠ¸ë¡œë§Œ ì‚¬ìš©ëœë‹¤ë©´, ì´ else ë¸”ë¡ì€ í•„ìš” ì—†ê±°ë‚˜
    // ì ‘ê·¼ ë°©ì‹ì´ ì˜ëª»ë˜ì—ˆìŒì„ ì•Œë¦¬ëŠ” ê°„ë‹¨í•œ ë©”ì‹œì§€ë§Œ ì¶œë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    // echo "ì˜ëª»ëœ ì ‘ê·¼ ë°©ì‹ì…ë‹ˆë‹¤.";
}

// --------------------------------------------------------------------
// ì¤‘ìš”: ìœ„ if ($_SERVER['REQUEST_METHOD'] === 'POST') ë¸”ë¡ ë‚´ì—ì„œ
// ëª¨ë“  ê²½ìš°ì— ëŒ€í•´ echo json_encode(...) í›„ exit; ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤.
// ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì´ PHP íŒŒì¼ì˜ ë‚˜ë¨¸ì§€ HTML ë¶€ë¶„ì´ ì‘ë‹µì— í¬í•¨ë©ë‹ˆë‹¤.
// --------------------------------------------------------------------
?>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›ì¤€ì´ì˜ ì›¹íˆ°ì¶”ì²œì†Œ</title>
    <link rel="stylesheet" href="/CSS/recommand_main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <script>
    async function handleSearch() {
        const userInput = document.getElementById('search-input').value;
        const resultDiv = document.getElementById('result');

        if (!userInput) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        resultDiv.innerHTML = '<p>ì¶”ì²œì„ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>';

        try {
            const response = await fetch('/html/recommand_main.php', { // PHP íŒŒì¼ ê²½ë¡œê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `text=${encodeURIComponent(userInput)}`
            });

            const responseText = await response.text(); // ì„œë²„ ì‘ë‹µì„ ë¨¼ì € í…ìŠ¤íŠ¸ë¡œ ë°›ìŒ
            let data;

            try {
                data = JSON.parse(responseText); // í…ìŠ¤íŠ¸ë¥¼ JSONìœ¼ë¡œ íŒŒì‹± ì‹œë„
            } catch (e) {
                // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, ê°œë°œìì—ê²ŒëŠ” ì˜¤ë¥˜ì™€ í•¨ê»˜ ì„œë²„ì˜ ì›ì‹œ ì‘ë‹µì„ ë³´ì—¬ì£¼ê³ ,
                // ì‚¬ìš©ìì—ê²ŒëŠ” ê°„ë‹¨í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤Œ.
                console.error('JSON Parsing Error:', e);
                console.error('Server Response Text:', responseText); // ê°œë°œì ì½˜ì†”ì— ì›ì‹œ ì‘ë‹µ ì¶œë ¥
                resultDiv.innerHTML = `<p>ì˜¤ë¥˜: ì„œë²„ë¡œë¶€í„° ë°›ì€ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜)</p>`;
                // alert('ì„œë²„ ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); // ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ë©”ì‹œì§€
                return;
            }

            if (data.error) {
                // ì„œë²„ê°€ JSON í˜•ì‹ìœ¼ë¡œ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ ê²½ìš°
                alert(data.error); // alertë³´ë‹¤ëŠ” resultDivì— í‘œì‹œí•˜ëŠ” ê²ƒì´ ë” ì¢‹ì„ ìˆ˜ ìˆìŒ
                resultDiv.innerHTML = `<p>ì˜¤ë¥˜: ${data.error}</p>`;
            } else if (data.recommended && data.recommended.length > 0) {
                let resultHTML = '<div class="webtoon-cards-container">';
                data.recommended.forEach((webtoon) => {
                    const webtoonUrl = `https://comic.naver.com/webtoon/list?titleId=${webtoon.S_N}`;
                    resultHTML += `
                        <div class="webtoon-card" onclick="window.location.href='${webtoonUrl}'">
                            <h3 class="webtoon-title">${webtoon.title || 'ì œëª© ì •ë³´ ì—†ìŒ'}</h3>
                            <p class="webtoon-tag"><strong>íƒœê·¸:</strong><br> ${webtoon.tag || 'íƒœê·¸ ì •ë³´ ì—†ìŒ'}</p>
                            <p class="webtoon-summary"><strong>ìš”ì•½:</strong><br> ${webtoon.summary || 'ìš”ì•½ ì •ë³´ ì—†ìŒ'}</p>
                        </div>
                    `;
                });
                resultHTML += '</div>';
                resultDiv.innerHTML = resultHTML;
            } else {
                 // ì¶”ì²œ ê²°ê³¼ëŠ” ìˆì§€ë§Œ ë‚´ìš©ì´ ë¹„ì–´ìˆê±°ë‚˜, recommended í‚¤ê°€ ìˆì§€ë§Œ ë¹ˆ ë°°ì—´ì¸ ê²½ìš°
                 resultDiv.innerHTML = '<p>ì¶”ì²œí•  ì›¹íˆ°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        } catch (error) {
            // fetch ìì²´ì˜ ì‹¤íŒ¨ ë˜ëŠ” ì˜ˆê¸°ì¹˜ ì•Šì€ JavaScript ì˜¤ë¥˜
            console.error('Fetch/JavaScript Error:', error);
            resultDiv.innerHTML = '<p>ì¶”ì²œ ì²˜ë¦¬ ì¤‘ ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            // alert('ì¶”ì²œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    </script>
</head>
<body>
    <header>
        <div class="logo-group">
            <a href="/index.html" class="logo">ì›¹íˆ°ì„¸ìƒ</a>
            <a href="/html/summary_main.html" class="logo">ì›¹íˆ°ìš”ì•½ì†Œ</a>
        </div>
    </header>
    <main>
        <h1>ì›¹íˆ°ì¶”ì²œì†Œ</h1>
        <div class="search-container">
            <input id="search-input" type="text" placeholder="ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ì˜ ì›¹íˆ°ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button onclick="handleSearch()">&#128269;</button>
        </div>
        <div id="result"></div> </main>
</body>
</html>

====
#!/usr/bin/env python3
import os
import sys
import json
import re
import pymysql
import google.generativeai as genai  # Gemini APIìš© ë¼ì´ë¸ŒëŸ¬ë¦¬

# --- Google API í‚¤ ì„¤ì • ---
GOOGLE_API_KEY = "AIzaSyA92rRzvNrYxm2ulzSm9CKzFGh7pnXHtW0"  # ì‹¤ì œ ìœ íš¨í•œ API í‚¤ë¡œ êµì²´í•˜ì„¸ìš”
if not GOOGLE_API_KEY:
    print(json.dumps({"error": "Google API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}, ensure_ascii=False))
    sys.exit(1)
genai.configure(api_key=GOOGLE_API_KEY)


# --- ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •) ---
db_config = {
    "host": "localhost",
    "user": "root",      # PHPì—ì„œ ì‚¬ìš©í•˜ëŠ” DB ì‚¬ìš©ìì™€ ì¼ì¹˜ì‹œí‚¤ê±°ë‚˜ ê¶Œí•œ í™•ì¸ í•„ìš”
    "password": "123",  # PHPì—ì„œ ì‚¬ìš©í•˜ëŠ” DB ë¹„ë°€ë²ˆí˜¸ì™€ ì¼ì¹˜ì‹œí‚¤ê±°ë‚˜ ê¶Œí•œ í™•ì¸ í•„ìš”
    "database": "webtoon",
    "charset": "utf8mb4"
}

# recommend.py íŒŒì¼ì˜ extract_keywords í•¨ìˆ˜ ìˆ˜ì • ì˜ˆì‹œ

def extract_keywords(user_input):
    """
    Gemini APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì…ë ¥ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œ
    """
    try:
        model = genai.GenerativeModel("gemini-1.5-pro-latest")
        prompt = f"ë‹¤ìŒ ì‚¬ìš©ì ìš”ì²­ì—ì„œ ì¤‘ìš”í•œ í‚¤ì›Œë“œë¥¼ 2~5ê°œ ì¶”ì¶œí•´ì„œ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ í˜•íƒœë¡œ ì•Œë ¤ì¤˜: \"{user_input}\""
        response = model.generate_content(prompt)

        keywords_str = ""
        if hasattr(response, 'text') and response.text:
            keywords_str = response.text.strip()
        elif hasattr(response, 'parts') and response.parts:
            keywords_str = "".join(part.text for part in response.parts if hasattr(part, 'text')).strip()
        

        if not keywords_str:
            print("Gemini APIë¡œë¶€í„° ë¹ˆ í‚¤ì›Œë“œ ë¬¸ìì—´ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.")
            # PHPì—ì„œ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ JSON ë°˜í™˜ (ì„ íƒì , ë˜ëŠ” ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜)
            # print(json.dumps({"error": "APIë¡œë¶€í„° í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."}, ensure_ascii=False))
            return [] # ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜

        keywords_list = [keyword.strip() for keyword in keywords_str.split(',') if keyword.strip()]
        
        processed_keywords = []
        for keyword in keywords_list:
            clean_keyword = re.sub(r'[^\w\s]', '', keyword) 
            if clean_keyword:
                processed_keywords.append(clean_keyword)
        
        
        if not processed_keywords:
            print("ìœ íš¨í•œ í‚¤ì›Œë“œê°€ ì¶”ì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        
        return list(set(processed_keywords))

    except Exception as e:
        error_message = f"í‚¤ì›Œë“œ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"

        print(json.dumps({"error": error_message}, ensure_ascii=False)) # PHP í˜¸í™˜ì„±ì„ ìœ„í•´
        return None

def search_webtoon(keywords):
    """
    ì¶”ì¶œëœ í‚¤ì›Œë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ webtoon_info, webtoon_text í…Œì´ë¸”ì—ì„œ
    ë§¤ì¹­ë„ê°€ ë†’ì€ ì›¹íˆ°(S_N)ì„ ìƒìœ„ 3ê°œ ê²€ìƒ‰
    """
    # í‚¤ì›Œë“œê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ ë¦¬ìŠ¤íŠ¸ë‚˜ ì ì ˆí•œ ë©”ì‹œì§€ ë°˜í™˜
    if not keywords:
        # ì´ ë©”ì‹œì§€ëŠ” recommend_webtoon í•¨ìˆ˜ì—ì„œ "í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨" ë©”ì‹œì§€ì™€ ì¤‘ë³µë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ,
        # ì—¬ê¸°ì„œ ì§ì ‘ JSON ì—ëŸ¬ë¥¼ ì¶œë ¥í•˜ê±°ë‚˜, Noneì„ ë°˜í™˜í•˜ì—¬ í˜¸ì¶œí•œ ìª½ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        # print(json.dumps({"error": "ê²€ìƒ‰í•  í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤."}, ensure_ascii=False))
        return "ì¶”ì²œí•  ì›¹íˆ°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." # ë˜ëŠ” ë¹ˆ ë¦¬ìŠ¤íŠ¸ []

    # search_webtoon í•¨ìˆ˜ ë‚´
    connection = pymysql.connect(
        host=db_config["host"],  # <--- "host" ì´ë¦„í‘œë¥¼ ì‚¬ìš©í•´ì„œ ê°’ì„ ê°€ì ¸ì˜´
        user=db_config["user"],
        password=db_config["password"],
        database=db_config["database"],
        charset=db_config["charset"]
    )

    try:
        with connection.cursor() as cursor:

            conditions = []
            for keyword in keywords:
                conditions.append(f"(wi.tag LIKE '%{keyword}%' OR wi.summary LIKE '%{keyword}%' OR wt.line LIKE '%{keyword}%')")
            

            keyword_condition_sql = " OR ".join(conditions)
            

            
            select_keyword_matches = []
            for i, keyword in enumerate(keywords):
                select_keyword_matches.append(f"""
                    (CASE 
                        WHEN (wi.tag LIKE '%{keyword}%' OR 
                              wi.summary LIKE '%{keyword}%' OR 
                              EXISTS (SELECT 1 FROM webtoon_text wt_sub WHERE wt_sub.S_N = wi.S_N AND wt_sub.line LIKE '%{keyword}%')) 
                        THEN 1 
                        ELSE 0 
                    END)
                """)
            
            if not select_keyword_matches: # í‚¤ì›Œë“œê°€ ì—†ëŠ” ê²½ìš°
                 return "ì¶”ì²œí•  ì›¹íˆ°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."


            query = f"""
                SELECT
                    wi.title,
                    wi.S_N,
                    ({ ' + '.join(select_keyword_matches) }) AS keyword_match_count
                FROM webtoon_info wi
                WHERE ( {' OR '.join(f"wi.tag LIKE '%{k}%' OR wi.summary LIKE '%{k}%' OR EXISTS (SELECT 1 FROM webtoon_text wt_sub WHERE wt_sub.S_N = wi.S_N AND wt_sub.line LIKE '%{k}%')" for k in keywords)} )
                GROUP BY wi.S_N, wi.title 
                ORDER BY keyword_match_count DESC
                LIMIT 3;
            """

            cursor.execute(query)
            results = cursor.fetchall()
            
            if results:
                # S_N (row[1])ì„ ë¬¸ìì—´ë¡œ ë°˜í™˜
                return [str(row[1]) for row in results]
            else:
                return "ì¶”ì²œí•  ì›¹íˆ°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    except pymysql.MySQLError as e:
        # ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ ë°œìƒ ì‹œ JSON í˜•íƒœë¡œ ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
        error_message = f"DB ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
        print(json.dumps({"error": error_message}, ensure_ascii=False))
        return None # ë˜ëŠ” "DB ê²€ìƒ‰ ì˜¤ë¥˜" ë“±ì˜ ë¬¸ìì—´ ë°˜í™˜í•˜ì—¬ PHPì—ì„œ ì²˜ë¦¬
    finally:
        connection.close()

def recommend_webtoon(user_input):
    """
    ì „ì²´ ì¶”ì²œ ë¡œì§:
    1. í‚¤ì›Œë“œë¥¼ ì¶”ì¶œ
    2. ì¶”ì¶œëœ í‚¤ì›Œë“œë¡œ DB ê²€ìƒ‰
    3. S_N ëª©ë¡ ë°˜í™˜
    """
    keywords = extract_keywords(user_input)
    
    # extract_keywordsì—ì„œ ì˜¤ë¥˜ ë°œìƒ ì‹œ Noneì´ ë°˜í™˜ë˜ê³ , PHPì—ì„œ ì²˜ë¦¬í•  JSON ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ì´ë¯¸ ì¶œë ¥ë¨
    if keywords is None:

        return {"error": "í‚¤ì›Œë“œ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë‚´ë¶€ ì˜¤ë¥˜ ë°œìƒ)"} # ì´ ë©”ì‹œì§€ëŠ” extract_keywordsì—ì„œ ì¶œë ¥ëœ JSONì— ë®ì–´ì“°ì´ì§€ ì•Šë„ë¡ ì£¼ì˜

    if not keywords: # í‚¤ì›Œë“œê°€ ë¹„ì–´ìˆëŠ” ë¦¬ìŠ¤íŠ¸ì¼ ê²½ìš°
        return {"recommended": ["í‚¤ì›Œë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜, ìœ íš¨í•œ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤."]}


    search_result = search_webtoon(keywords)

    if search_result is None: # DB ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (search_webtoonì—ì„œ JSON ì˜¤ë¥˜ ì¶œë ¥ë¨)
        return {"error": "ì›¹íˆ° ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (DB ì˜¤ë¥˜ ê°€ëŠ¥ì„±)"}
    
    if isinstance(search_result, str): # "ì¶”ì²œí•  ì›¹íˆ°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." ì™€ ê°™ì€ ë¬¸ìì—´ ë©”ì‹œì§€
        return {"recommended": [search_result]}
    
    # ì„±ê³µì ìœ¼ë¡œ S_N ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì€ ê²½ìš°
    return {"recommended": search_result}


if __name__ == "__main__":
    if len(sys.argv) < 2:
        # ì´ ì˜¤ë¥˜ëŠ” PHP ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì ì—ì„œ ë°œìƒí•˜ì§€ ì•Šë„ë¡ PHPì—ì„œ ì…ë ¥ê°’ ê²€ì¦ì„ í•©ë‹ˆë‹¤.
        # í„°ë¯¸ë„ì—ì„œ ì§ì ‘ ì‹¤í–‰ ì‹œë¥¼ ëŒ€ë¹„í•œ êµ¬ë¬¸ì…ë‹ˆë‹¤.
        print(json.dumps({"error": "ì‚¬ìš©ì ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤."}, ensure_ascii=False))
        sys.exit(0) # PHPì—ì„œ shell_execë¡œ ì‹¤í–‰ë  ë•ŒëŠ” ì´ exit ì½”ë“œê°€ PHPì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŒ

    user_input = sys.argv[1]
    
    # recommend_webtoonì´ ì§ì ‘ ë”•ì…”ë„ˆë¦¬(JSON êµ¬ì¡°)ë¥¼ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •í–ˆìœ¼ë¯€ë¡œ,
    # í•´ë‹¹ ê²°ê³¼ë¥¼ ë°”ë¡œ JSONìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
    recommendation_result = recommend_webtoon(user_input)
    
    # ìµœì¢… ì¶œë ¥ì€ í•­ìƒ JSON í˜•íƒœê°€ ë˜ë„ë¡ í•©ë‹ˆë‹¤.
    print(json.dumps(recommendation_result, ensure_ascii=False))



====================================================================================================================================
2025-08-25
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì›ì¤€ì´ì˜ ì›¹íˆ°ìš”ì•½ì†Œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../CSS/summary_main.css">
</head>
<body>
  <header>
    <nav class="logo-group">
      <a href="/index.html" class="logo">ì›¹íˆ°ì„¸ìƒ</a>
      <a href="/html/recommand_main.php" class="logo">ì›¹íˆ°ì¶”ì²œì†Œ</a>
    </nav>
  </header>

  <main>
    <h1>ì›¹íˆ°ìš”ì•½ì†Œ</h1>
    <div class="search-container">
      <form id="search-form">
        <input
          type="text"
          id="search-query"
          class="search-input"
          placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          autocomplete="off"
        />
        <button type="submit" class="search-btn">ğŸ”</button>
      </form>
    </div>
  </main>

  <div class="popup" id="search-popup">
    <div class="popup-header">ê²€ìƒ‰ ê²°ê³¼</div>
    <div class="popup-content">
      <p><strong>ì›¹íˆ° ì œëª©:</strong> <span id="webtoon-title"></span></p>
      <p><strong>ì—°ì¬ ìš”ì¼:</strong> <span id="webtoon-day"></span></p>
      <p><strong>ë§ˆì§€ë§‰ í™”:</strong> <span id="webtoon-last"></span></p>
      <div class="episode-input-group">
        <label for="start-episode">ì‹œì‘ í™”:</label>
        <input type="number" id="start-episode" placeholder="1" />
      </div>
      <div class="episode-input-group">
        <label for="end-episode">ë§ˆì§€ë§‰ í™”:</label>
        <input type="number" id="end-episode" placeholder="3" />
      </div>
    </div>
    <div class="popup-footer">
      <button id="submit-request">ìš”ì•½ ìš”ì²­</button>
      <button type="button" onclick="closePopup()">ë‹«ê¸°</button>
    </div>
  </div>

  <div class="popup" id="progress-popup">
    <div class="popup-header">ìš”ì•½ ì§„í–‰</div>
    <div class="popup-content">
      <p id="progress-text">ìš”ì•½ì¤‘...</p>
    </div>
  </div>

  <div class="popup" id="result-popup">
    <div class="popup-header">ìš”ì•½ ê²°ê³¼</div>
    <div class="popup-content">
      <p id="page-info"></p>
      <p id="summary-text" style="white-space: pre-wrap;"></p>
    </div>
    <div class="popup-footer">
      <button id="prev-page">ì´ì „</button>
      <button id="next-page">ë‹¤ìŒ</button>
      <button type="button" onclick="closePopup()">ë‹«ê¸°</button>
    </div>
  </div>

  <script>
    let currentWebtoonId = null;
    let maxEpisode = 0;
    let pages = []; // ê° chunkì˜ ìš”ì•½ ê²°ê³¼ë¥¼ ì €ì¥
    let pageRanges = []; // ê° chunkì˜ ì‹œì‘/ì¢…ë£Œ í™” ì •ë³´ë¥¼ ì €ì¥
    let currentPage = 0; // í˜„ì¬ ë³´ì—¬ì£¼ëŠ” chunkì˜ ì¸ë±ìŠ¤

    function openPopup(id) {
      document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }
    function closePopup() {
      document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
    }

    document.getElementById('search-form').addEventListener('submit', e => {
      e.preventDefault();
      const q = document.getElementById('search-query').value.trim();
      if (!q) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

      fetch(`/php/search_webtoon.php?title=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => {
          if (data.error) return alert(data.error);
          document.getElementById('webtoon-title').textContent = data.title;
          document.getElementById('webtoon-day').textContent = data.day;
          document.getElementById('webtoon-last').textContent = data.last;
          currentWebtoonId = data.S_N;
          maxEpisode = parseInt(data.last, 10);
          openPopup('search-popup');
        })
        .catch(err => {
          console.error(err);
          alert('ê²€ìƒ‰ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    });

    // 'submit-request' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ async í•¨ìˆ˜ë¡œ ë³€ê²½
    document.getElementById('submit-request').addEventListener('click', async () => {
      const startEp = parseInt(document.getElementById('start-episode').value, 10);
      const endEp = parseInt(document.getElementById('end-episode').value, 10);
      if (isNaN(startEp) || isNaN(endEp))
        return alert('ì‹œì‘ í™”ì™€ ë§ˆì§€ë§‰ í™”ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      if (startEp < 1 || endEp > maxEpisode || startEp > endEp)
        return alert(`1 â‰¤ ì‹œì‘ í™” â‰¤ ë§ˆì§€ë§‰ í™” â‰¤ ${maxEpisode} ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);

      // í˜ì´ì§€ ë¶„í• : 15í™”ì”© (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
      pages = []; // ê²°ê³¼ ë°°ì—´ ì´ˆê¸°í™”
      pageRanges = []; // í˜ì´ì§€ ë²”ìœ„ ë°°ì—´ ì´ˆê¸°í™”
      currentPage = 0; // í˜„ì¬ í˜ì´ì§€ ì¸ë±ìŠ¤ ì´ˆê¸°í™”

      for (let i = startEp; i <= endEp; i += 15) {
        const chunkStart = i;
        const chunkEnd = Math.min(i + 14, endEp);
        pageRanges.push({ start: chunkStart, end: chunkEnd });
      }

      openPopup('progress-popup');
      const progressTextElement = document.getElementById('progress-text');
      const collectedResults = []; // ìˆœì°¨ì ìœ¼ë¡œ ë°›ì•„ì˜¨ ìš”ì•½ ê²°ê³¼ë¥¼ ì €ì¥í•  ë°°ì—´

      try {
        // pageRangesì— ëŒ€í•´ ìˆœì°¨ì ìœ¼ë¡œ fetch ìš”ì²­ì„ ë³´ëƒ„
        for (let i = 0; i < pageRanges.length; i++) {
          const range = pageRanges[i];
          progressTextElement.textContent = `ìš”ì•½ ì§„í–‰ ì¤‘... (${range.start}í™” ~ ${range.end}í™”) [${i + 1}/${pageRanges.length}]`;
          
          const response = await fetch(`/php/get_summary.php?S_N=${currentWebtoonId}&start=${range.start}&end=${range.end}`);
          
          // HTTP ì‘ë‹µ ìƒíƒœ í™•ì¸
          if (!response.ok) {
            let errorMsg = `HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`;
            try {
              // ì„œë²„ì—ì„œ JSON í˜•íƒœì˜ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ íŒŒì‹± ì‹œë„
              const errorData = await response.json();
              if (errorData && errorData.error) {
                errorMsg = errorData.error;
              }
            } catch (e) {
              // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, ì›ë˜ HTTP ì˜¤ë¥˜ ë©”ì‹œì§€ ì‚¬ìš©
            }
            throw new Error(`[${range.start}í™”~${range.end}í™” ì²˜ë¦¬ ì¤‘] ${errorMsg}`);
          }
          
          const data = await response.json();
          if (data.result) {
            collectedResults.push(data.result);
          } else {
            // data.errorê°€ ìˆì„ ê²½ìš° í•´ë‹¹ ë©”ì‹œì§€ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€
            throw new Error(`[${range.start}í™”~${range.end}í™” ì²˜ë¦¬ ì¤‘] ${data.error || 'ìš”ì•½ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'}`);
          }
        }

        pages = collectedResults; // ëª¨ë“  ìš”ì²­ì´ ì„±ê³µí•˜ë©´ ê²°ê³¼ë¥¼ pagesì— í• ë‹¹
        if (pages.length > 0) {
          currentPage = 0; // ì²« ë²ˆì§¸ í˜ì´ì§€(chunk)ë¶€í„° ë³´ì—¬ì£¼ë„ë¡ ì„¤ì •
          updateSummaryDisplay();
          openPopup('result-popup');
        } else if (pageRanges.length > 0) { // ìš”ì²­í•  í˜ì´ì§€ëŠ” ìˆì—ˆìœ¼ë‚˜ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°
          alert('ìš”ì•½ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ (ëª¨ë“  êµ¬ê°„ ê²°ê³¼ ì—†ìŒ).');
          closePopup();
        } else { // ì• ì´ˆì— ìš”ì²­í•  í˜ì´ì§€ ë²”ìœ„ê°€ ì—†ì—ˆë˜ ê²½ìš° (startEp > endEp ë“± - ì´ë¯¸ ìœ„ì—ì„œ í•„í„°ë§ë˜ì§€ë§Œ ë°©ì–´ ì½”ë“œ)
            alert('ìš”ì²­í•  í™” ë²”ìœ„ê°€ ì—†ìŠµë‹ˆë‹¤.');
            closePopup();
        }

      } catch (err) {
        console.error('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err);
        alert('ìš”ì•½ ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        closePopup(); // ì˜¤ë¥˜ ë°œìƒ ì‹œ íŒì—… ë‹«ê¸°
      } finally {
        // ì§„í–‰ í…ìŠ¤íŠ¸ ì´ˆê¸°í™” (ì˜µì…˜)
        progressTextElement.textContent = 'ìš”ì•½ì¤‘...';
      }
    });

    function updateSummaryDisplay() {
      const infoEl = document.getElementById('page-info');
      const textEl = document.getElementById('summary-text');
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      
      if (pages.length === 0 || !pageRanges[currentPage]) {
        infoEl.textContent = 'í‘œì‹œí•  ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤.';
        textEl.textContent = '';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }

      const range = pageRanges[currentPage];
      infoEl.textContent = `Phase ${currentPage + 1}/${pages.length}: ${range.start}í™”~${range.end}í™”`;
      textEl.textContent = pages[currentPage];
      prevBtn.disabled = currentPage === 0;
      nextBtn.disabled = currentPage === pages.length - 1;
    }

    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        updateSummaryDisplay();
      }
    });

    document.getElementById('next-page').addEventListener('click', () => {
      if (currentPage < pages.length - 1) {
        currentPage++;
        updateSummaryDisplay();
      }
    });
  </script>
</body>
</html>

summary_main

<?php
// ----------------------------
// (1) Gemini API í‚¤ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
// ----------------------------
putenv("AIzaSyCYs36VA-vB75FoP8zkjC_PAEjvEubn02U");

// ----------------------------
// (2) MySQL ì—°ê²° ì„¤ì • ë“±
// ----------------------------
$host = 'localhost';
$db   = 'webtoon';
$user = 'root';
$pass = '123';

// ----------------------------
// (3) GET íŒŒë¼ë¯¸í„° S_N, start, end ì¡´ì¬ ì—¬ë¶€ í™•ì¸
// ----------------------------
if (isset($_GET['S_N'], $_GET['start'], $_GET['end'])) {
    $S_N   = $_GET['S_N'];
    $start = $_GET['start'];
    $end   = $_GET['end'];

    // ------------------------
    // DB ì—°ê²°
    // ------------------------
    $conn = new mysqli($host, $user, $pass, $db);
    if ($conn->connect_error) {
        die("Connection failed: " . $conn->connect_error);
    }

    // ------------------------
    // webtoon_text í…Œì´ë¸”ì—ì„œ episode, line ì¡°íšŒ
    // ------------------------
    $sql  = "SELECT episode, line FROM webtoon_text WHERE S_N = ? AND episode BETWEEN ? AND ?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param('iii', $S_N, $start, $end);
    $stmt->execute();
    $stmt->store_result();

    // ì˜ˆìƒ íšŒì°¨ ìˆ˜
    $expectedCount = $end - $start + 1;
    $numFound = $stmt->num_rows;

    // ------------------------
    // (B) DBì— ë°ì´í„°ê°€ ë¶ˆì™„ì „í•œ ê²½ìš° -> auto_update.py ì‹¤í–‰í•˜ì—¬ ëˆ„ë½ëœ íšŒì°¨ ë‹¤ìš´ë¡œë“œ
    // ------------------------
    if ($numFound < $expectedCount) {
        $auto_update_script = '/var/www/html/Python/auto_update.py';  // ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
        $command = escapeshellcmd("python3 $auto_update_script $S_N $start $end");
        $output  = shell_exec($command . " 2>&1");
        error_log("Auto update script output: " . $output);

        // Python ì‹¤í–‰ í›„ DB ì¬ì¡°íšŒ
        $stmt->execute();
        $stmt->store_result();
    }

    // ------------------------
    // (A) DBì— ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° -> ìš”ì•½ ì§„í–‰
    // ------------------------
    $episodes = [];
    $stmt->bind_result($episode, $line);
    while ($stmt->fetch()) {
        $episodes[] = "í™” {$episode}: {$line}";
    }

    if (count($episodes) > 0) {
        $input_text = implode("\n", $episodes);
        $summary = get_gemini_summary($input_text);
        echo json_encode(['result' => $summary]);
    } else {
        error_log("No data added to the database after running auto_update.py.");
        echo json_encode(['error' => 'ë°ì´í„°ë¥¼ ì¶”ê°€í–ˆì§€ë§Œ ìš”ì•½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.']);
    }

    $stmt->close();
    $conn->close();
} else {
    echo json_encode(['error' => 'í•„ìš”í•œ ë§¤ê°œë³€ìˆ˜ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.']);
}

// ----------------------------
// (4) Gemini API ìš”ì•½ í˜¸ì¶œ í•¨ìˆ˜
// ----------------------------
function get_gemini_summary($text) {
    $api_script   = '/var/www/html/Python/summary_api.py';
    $encoded_text = escapeshellarg($text);
    $task_type    = escapeshellarg("summary");  // summary ì‘ì—… ëª…ì‹œ
    $command      = "python3 $api_script $encoded_text $task_type";
    $result       = shell_exec($command . " 2>&1");
    error_log("Python script output: " . $result);
    $response     = json_decode($result, true);
    return $response['result'] ?? 'Gemini API í˜¸ì¶œ ì˜¤ë¥˜';
}
?>

get_summary.php

<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);
header('Content-Type: application/json');
// MySQL ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •
$host = 'localhost';
$db = 'webtoon';
$user = 'root';
$pass = '123';

// ì œëª©ìœ¼ë¡œ ì›¹íˆ°ì„ ê²€ìƒ‰í•˜ì—¬ S_N ë²ˆí˜¸ë¥¼ ë°˜í™˜í•˜ëŠ” ì½”ë“œ
if (isset($_GET['title'])) {
    $title = $_GET['title'];

    // DB ì—°ê²°
    $conn = new mysqli($host, $user, $pass, $db);
    if ($conn->connect_error) {
        die("Connection failed: " . $conn->connect_error);
    }

    $sql = "SELECT S_N, title, day, last FROM webtoon_info WHERE title LIKE ?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param('s', $title);
    $stmt->execute();
    $stmt->store_result();

    if ($stmt->num_rows > 0) {
        $stmt->bind_result($S_N, $title, $day, $last);
        $stmt->fetch();
        echo json_encode(['S_N' => $S_N, 'title' => $title, 'day' => $day, 'last' => $last]);
    } else {
        echo json_encode(['error' => 'ì›¹íˆ°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.']);
    }

    $stmt->close();
    $conn->close();
}
?>

search_webtoon.php