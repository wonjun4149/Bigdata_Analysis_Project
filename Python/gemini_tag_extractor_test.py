import google.generativeai as genai
import sys
import json

GOOGLE_API_KEY = "AIzaSyCYs36VA-vB75FoP8zkjC_PAEjvEubn02U" 

genai.configure(api_key=GOOGLE_API_KEY)

def extract_tags_from_story(story):
    """주어진 스토리에서 웹툰 태그를 중요도 순으로 2~7개 추출하는 함수 (JSON 모드 사용)"""
    try:
        all_tags_str = "판타지, 판타지개그, 서양, 모험, 전쟁, 정치, 용사, 왕족/귀족, 개그, 성장물, 절망적인, 크리처, 세계관, 아포칼립스, sf, 먼치킨, 다크판타지, 신화, 마법, 로맨스, 인외존재, 복수극, 현대, 이능력, 배틀, 이능력배틀물, 두뇌싸움, 액션, 학원액션, 소년물, 참교육, 격투기, 학원물, 스포츠, 우정, 라이벌, 청춘, 성장드라마, 스포츠성장, 무협/사극, 시리어스, 과거, 동양, 시대물, 역사물, 판무, 일상, 공감, 결혼생활, 가족, 연애/결혼공감, 가벼운, 무해한, 러블리, 힐링, 드라마, 사이다, 인플루언서, 역사판타지, 리얼로맨스, 첫사랑, 짝사랑남, 능력남, 명랑녀, 드라마&영화, 원작웹툰, 친구>연인, 설렘폭발, 외유내강녀, 햇살녀, 햇살캐, 하이틴, 학원로맨스, 직진남, 청춘로맨스, 삼각관계, 까칠남, 감성드라마, 중세판타지액션, 열혈병맛개그, 블랙코미디, 옴니버스, 병맛, 데스게임, 서바이벌, 최강자전, 걸크러시, 자본주의, 타임슬립, 회귀, 머니게임, 눈물샘자극, 사회고발, 스릴러, 오컬트판타지, 오컬트, 4차원, 서스펜스, 괴담, 힘숨찐, 사이비종교, 캠퍼스, 공식미남, 연하남, 연상녀, 평범녀, 철벽녀, 아카데미물, 동물, 블루스트링, 직업드라마, 소년왕도물, 액션판타지, 던전물, 게임판타지, 오피스, 평범남, 재회, 음식&요리, 고자극드라마, 자극적인, 악역이주인공, 빌런, 피카레스크, 할리퀸, 재벌남, 소심녀, 순진녀, 다정녀, 재벌, 다정남, 사연녀, 후회물, 궁중로맨스, 혐관로맨스, 이세계, 역하렘, 연상연하, 선결혼후연애, 로판, 소설원작, 러브코미디, 소심남, 공식미녀, 무심녀, 인소감성, 레트로, 열혈, 슈퍼스트링, 사연남, 능력녀, 퓨전사극, 레드아이스, 스튜디오, 게임, 헌터물, 구원서사, 상태창, 느와르, 지상최대공모전, 축구, 미래, 감성, 햇살남, 순정남, 짝사랑, 다크히어로, 밀리터리, 빙의, 현대판타지, 범죄, 법정드라마, 고인물, 순진남, 치명적인, 헌신남, 유혹남, 능글남, 군림녀, 폭스남, 감염, 성장로판, 육아물, 의학드라마, 명작, 동양풍판타지, 환골탈태, 차원이동, 환생, 하렘, 인생역전, 하이퍼리얼리즘, 계략녀, 미스터리, 집착녀, 캠퍼스로맨스, 액션아포칼립스, 좀비, 연예계, 중년, 중세, 집착남, 짝사랑녀, 로맨틱코미디, 레드스트링, 동양풍로맨스, 유혹녀, 연예계로맨스, 직진녀, 계약연애, 소꿉친구, 로맨스코미디, 생존, 감성적인, 아이돌, SF액션, 혐관, 정통무협, 고자극스릴러, 나쁜남자, 집착물, 이세계요리, 무심남, 대형견남, 고자극로맨스, 계략남, 악녀, 동아리, 요즘핫한추천작, 오피스로맨스, 지금추천작, 야구, 사내연애, 농사, 미친작화, 예술, 공감성수치, 해외작품, 전남친, 일상개그힐링, 낮져밤이, 음악, 비밀연애, 까칠녀, 뱀파이어, 짐승남, 연재직행열차, 스핀오프, 후회남, 아방녀, 아이돌연애, 공포, 프리퀄, 순정녀, 얼빠녀, 재벌녀, 히어로, 4컷만화, 농구"
      
        prompt = f"""
                    당신은 웹툰의 핵심을 꿰뚫어 보는 웹툰 큐레이션 전문가입니다.
                    주어진 웹툰 스토리 설명에서 핵심적인 특징을 가장 잘 나타내는 태그를 '전체 태그 목록' 중에서 선택해주세요. 주어지지 않은 태그는 절대 출력하지 마세요.

                    - 선택 개수: 스토리의 복잡성에 따라 2개 이상, 7개 이하의 태그를 선택하세요. 개수는 2개에서 7개 사이라면 유동적으로 조절하세요.
                    - 정확성: 관련 없는 태그를 억지로 추가하여 7개를 채우지 마세요. '학교 개그만화'나 주인공이 모험을 떠나는 만화' 수준의 단순한 스토리 요청이라면, 2개의 핵심 태그만 출력해도 충분합니다. 그러나 구체적인 스토리 설명으로 요청되었다면, 관련성이 높은 7개 이하의 태그를 출력하세요.
                    - 중요도 순서: 태그는 가장 중요한 순서대로 정렬해야 합니다.
                    - 출력 형식: 응답은 반드시 `{{"tags": ["가장중요한태그", "두번째로 중요한태그", ...]}}` 형식의 JSON 객체여야 합니다.

                    ---
                    사용자 스토리: "{story}"

                    전체 태그 목록: [{all_tags_str}]
                    ---
                  """

        model = genai.GenerativeModel("gemini-2.5-flash")
        
        generation_config = genai.types.GenerationConfig(
            response_mime_type="application/json"
        )
        
        response = model.generate_content(prompt, generation_config=generation_config)
        
        result_json = json.loads(response.text)
        
        return {"status": "success", "tags": result_json.get("tags", [])}

    except Exception as e:
        return {"status": "error", "message": f"Python Gemini API 오류: {str(e)}"}

if __name__ == "__main__":
    if not GOOGLE_API_KEY or GOOGLE_API_KEY == "ㅁㅁㅁ":
        print(json.dumps({"status": "error", "message": "Python 스크립트에 Google API 키가 설정되지 않았습니다."}))
        sys.exit(1)
        
    if len(sys.argv) < 2:
        print(json.dumps({"status": "error", "message": "스토리가 전달되지 않았습니다."}))
        sys.exit(1)

    input_story = sys.argv[1]
    result = extract_tags_from_story(input_story)
    
    print(json.dumps(result, ensure_ascii=False))